<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Org Manager - Verification Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }

        .log-box {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .status-badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 12px;
        }
    </style>
</head>

<body>
    <div id="app" class="container py-5">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <h1 class="display-6 fw-bold">Organization Manager <span class="text-primary">v1.0</span></h1>
            <div class="input-group w-auto">
                <span class="input-group-text">API URL</span>
                <input type="text" class="form-control" v-model="apiBaseUrl" placeholder="http://localhost:8000">
            </div>
        </header>

        <div class="row">
            <!-- Left Column: Controls -->
            <div class="col-md-6">

                <!-- 1. Create Organization -->
                <div class="card p-4">
                    <h5 class="card-title fw-bold mb-3">1. Create Organization</h5>
                    <div class="mb-3">
                        <input v-model="createForm.name" type="text" class="form-control mb-2"
                            placeholder="Organization Name (e.g. Tesla)">
                        <input v-model="createForm.email" type="email" class="form-control mb-2"
                            placeholder="Admin Email">
                        <input v-model="createForm.password" type="password" class="form-control mb-2"
                            placeholder="Password">
                        <button @click="createOrg" class="btn btn-primary w-100" :disabled="loading">Create
                            Organization</button>
                    </div>
                </div>

                <!-- 2. Login -->
                <div class="card p-4">
                    <h5 class="card-title fw-bold mb-3">2. Admin Login</h5>
                    <div class="mb-3">
                        <input v-model="loginForm.email" type="email" class="form-control mb-2"
                            placeholder="Admin Email">
                        <input v-model="loginForm.password" type="password" class="form-control mb-2"
                            placeholder="Password">
                        <button @click="login" class="btn btn-success w-100" :disabled="loading">Login & Get
                            Token</button>
                    </div>
                </div>

                <!-- 3. Manage Org (Protected) -->
                <div class="card p-4" :class="{ 'opacity-50': !token }">
                    <h5 class="card-title fw-bold mb-3">3. Manage Organization (Protected)</h5>
                    <div v-if="orgDetails" class="alert alert-info py-2">
                        <small>Current Name: <strong>{{ orgDetails.name }}</strong></small><br>
                        <small>Collection: <strong>{{ orgDetails.collection_name }}</strong></small>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <button @click="getOrg" class="btn btn-outline-info flex-grow-1"
                            :disabled="!token || loading">Verify Identity (GET Me)</button>
                    </div>
                    <div class="input-group mb-2">
                        <input v-model="updateForm.name" type="text" class="form-control" placeholder="New Org Name">
                        <button @click="updateOrg" class="btn btn-warning" :disabled="!token || loading">Rename
                            (Migrate)</button>
                    </div>
                    <hr>
                    <button @click="deleteOrg" class="btn btn-danger w-100" :disabled="!token || loading">Delete
                        Organization (Danger)</button>
                </div>

            </div>

            <!-- Right Column: Logs -->
            <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold m-0">Live API Logs</h5>
                    <button @click="logs = []" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>
                <div class="log-box">
                    <div v-if="logs.length === 0" class="text-muted text-center mt-5">Ready to verify...</div>
                    <div v-for="(log, i) in logs" :key="i" class="mb-2">
                        <div class="small opacity-75">[{{ log.time }}] <span
                                :class="log.type === 'ERROR' ? 'text-danger' : 'text-primary'">{{ log.method }}</span>
                            {{ log.url }}</div>
                        <div class="text-white">{{ log.data }}</div>
                        <hr class="border-secondary opacity-25 my-1">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue
        createApp({
            data() {
                return {
                    // Automatically use current origin if not running locally, otherwise default to local backend
                    apiBaseUrl: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                        ? 'http://127.0.0.1:8000' 
                        : window.location.origin, 
                    token: null,
                    loading: false,
                    createForm: { name: '', email: '', password: '' },
                    loginForm: { email: '', password: '' },
                    updateForm: { name: '' },
                    orgDetails: null,
                    logs: []
                }
            },
            methods: {
                log(method, url, data, type = 'INFO') {
                    const time = new Date().toLocaleTimeString();
                    this.logs.unshift({ time, method, url, data: typeof data === 'string' ? data : JSON.stringify(data, null, 2), type });
                },
                async request(method, endpoint, body = null, auth = false) {
                    this.loading = true;
                    // Ensure no double slashes if apiBaseUrl ends with /
                    const baseUrl = this.apiBaseUrl.replace(/\/$/, ""); 
                    const url = `${baseUrl}${endpoint}`;
                    const headers = { 'Content-Type': 'application/json' };
                    if (auth && this.token) headers['Authorization'] = `Bearer ${this.token}`;

                    try {
                        const opts = { method, headers };
                        if (body) opts.body = JSON.stringify(body);
                        
                        const res = await fetch(url, opts);
                        let data;
                        try {
                             data = await res.json();
                        } catch (err) {
                            data = { detail: "Non-JSON response (possibly 404 or 500 HTML)" };
                        }
                        
                        this.log(method, endpoint, data, res.ok ? 'SUCCESS' : 'ERROR');
                        
                        if (!res.ok) throw new Error(data.detail || 'Request failed');
                        return data;
                    } catch (e) {
                        console.error(e);
                        this.log(method, endpoint, e.message, 'ERROR'); // Log error to UI
                        return null; 
                    } finally {
                        this.loading = false;
                    }
                },
                async createOrg() {
                    const res = await this.request('POST', '/organizations', this.createForm);
                    if (res) {
                        // Auto-fill login
                        this.loginForm.email = this.createForm.email;
                        this.loginForm.password = this.createForm.password;
                    }
                },
                async login() {
                    const res = await this.request('POST', '/admin/login', this.loginForm);
                    if (res && res.access_token) {
                        this.token = res.access_token;
                        this.getOrg(); // Auto-fetch details
                    }
                },
                async getOrg() {
                    const res = await this.request('GET', '/organizations/me', null, true);
                    if (res) this.orgDetails = res;
                },
                async updateOrg() {
                    if (!this.updateForm.name) return;
                    const res = await this.request('PUT', '/organizations/me', this.updateForm, true);
                    if (res) this.getOrg(); // Refresh
                },
                async deleteOrg() {
                    if (!confirm("Are you sure? This will delete your account and all data.")) return;
                    const res = await this.request('DELETE', '/organizations/me', null, true);
                    if (res) {
                        this.token = null;
                        this.orgDetails = null;
                        this.logs.unshift({ time: new Date().toLocaleTimeString(), method: 'SYSTEM', url: 'Client', data: "Logged out after deletion", type: 'INFO' });
                    }
                }
            }
        }).mount('#app')
    </script>
</body>

</html>